REM PRG3_OPER-AH (CONTROL: PAH PAF PAC UMA02)
REM PROGRAMA DE OPERACION DE PLANTA DE AGUA HELADA
REM AUTHOR CARLOS JIMENEZ HIRASHI @cjhirashi
REM VERSION 1.0.0

REM DECLARACION DE VARIABLES

    LOCALS SYS, ST_B, ST_CH, PID, PID_B : REM (LECTURA) ESTADO DE EQUIPOS Y ACTIVACION
    LOCALS CH_Q, CH_UQ, P_CH 			: REM (LECTURA) CAUDAL DE AGUA CHILLER
    LOCALS SS_CH, SS_B, CN_B 			: REM (ESCRITURA) CONTROL DE BOMBA Y CHILLER
    LOCALS CN_BP						: REM (ESCRITURA) CONTROL DE BYPASS
    LOCALS CH, TM_ON, TM_OFF, BP_OFF	: REM (VAR INT) VARIABLES DE CONTROL
    LOCALS V_B_MAX, V_B_MIN, V_B		: REM (LECTURA VAR IN) CONTROL VELOCIDAD DE BOMBA

REM VARIABLES DE ENTRADA

    SYS = BV6		: REM ACTIVACION DEL SISTEMA DE CONTROL
    ST_B = BI15		: REM ESTADO DE OPERACION DE BOMBA
    ST_CH = BI16	: REM ESTADO DE OPERACION DE CHILLER
    CH_Q = AV29		: REM CAUDAL DE AGUA PARA CHILLER
    CH_UQ = AV32	: REM CAUDAL DE AGUA MIN PARA CHILLER

    TM_ON = 120		: REM TIEMPO MINIMO DE OPERACION DEL SISTEMA (SEC)
    TM_OFF = 120	: REM TIEMPO MINIMO DE PARA DEL SISTEMA (SEC)

    PID = LOOP2		: REM DEMANDA DE APERTURA BYPASS (%)
    BP_OFF = 50		: REM APERTURA DE BYPASS EN SISTEMA APAGADO (%)
    PID_B = AV36	: REM DEMANDA DE VELOCIDAD PARA BOMBA

    V_B_MAX = 100	: REM VELOCIDAD DE BOMBA MAXIMA (HZ)
    V_B_MIN = 30	: REM VELOCIDAD DE BOMBA MINIMA (HZ)

REM CONTROL DE SISTEMA

    REM *ARRANQUE Y PARO DE SISTEMA
    	IF SYS = 1 AND TIMEOFF( CH ) > TM_OFF THEN CH = 1
    	IF SYS = 0 AND TIMEON( CH ) > TM_ON THEN CH = 0

    	IF CH = 1 THEN
    		SS_B = 1
    		IF TIMEON(P_CH) > 20 THEN SS_CH = 1 ELSE SS_CH = 0
    	 ELSE
    		SS_CH = 0
    		IF TIMEOFF(SS_CH) > 120 THEN SS_B = 0
    	ENDIF

    REM *ACTIVACION DE CONTROL DE BYPASS
    	IF TIMEON(SS_B) > 30 THEN CN_BP = PID ELSE CN_BP = BP_OFF

    REM *ACTIVACION DE CONTROL DE VELOCIDAD DE BOMBA
    	IF TIMEON(SS_B) > 15 THEN V_B = PID_B
    	IF SS_B = 0 THEN V_B = V_B_MIN

    	V_B = MAX( V_B_MIN , MIN( V_B_MAX , V_B ) )
    	CN_B = V_B

    IF CH_Q > CH_UQ THEN P_CH = 1 ELSE P_CH = 1

REM VARIABLES DE SALIDA

    BO5 = SS_CH
    BO6 = SS_B
    AO7 = CN_B
    AO8 = CN_BP

REM SENAL DE VELOCIDAD DE VARIADOR DE HZ A VOLTAJE
	REM AO7 = 0.17 * AV17	: REM CONVIERTE LA SENAL DE HZ A VOLTAJE

END